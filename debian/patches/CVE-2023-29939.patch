From 466aa585c6dfb096bf9a7ad9bcbc6ce8cc7abff1 Mon Sep 17 00:00:00 2001
From: Jakub Kuderski <kubak@google.com>
Date: Fri, 13 Jan 2023 10:55:04 -0500
Subject: [PATCH] [mlir][spirv] Fix crash in spirv-lower-abi-attributes

... when the are no SPIR-V env attributes.

Fixes: https://github.com/llvm/llvm-project/issues/59983

Reviewed By: antiagainst

Differential Revision: https://reviews.llvm.org/D141695
---
 .../SPIRV/Transforms/LowerABIAttributesPass.cpp        |  7 ++++++-
 mlir/test/Dialect/SPIRV/Transforms/abi-interface.mlir  | 10 +++++++++-
 2 files changed, 15 insertions(+), 2 deletions(-)

--- llvm-toolchain-15-15.0.7.orig/mlir/lib/Dialect/SPIRV/Transforms/LowerABIAttributesPass.cpp
+++ llvm-toolchain-15-15.0.7/mlir/lib/Dialect/SPIRV/Transforms/LowerABIAttributesPass.cpp
@@ -239,7 +239,12 @@ void LowerABIAttributesPass::runOnOperat
   spirv::ModuleOp module = getOperation();
   MLIRContext *context = &getContext();
 
-  spirv::TargetEnv targetEnv(spirv::lookupTargetEnv(module));
+  spirv::TargetEnvAttr targetEnvAttr = spirv::lookupTargetEnv(module);
+  if (!targetEnvAttr) {
+    module->emitOpError("missing SPIR-V target env attribute");
+    return signalPassFailure();
+  }
+  spirv::TargetEnv targetEnv(targetEnvAttr);
 
   SPIRVTypeConverter typeConverter(targetEnv);
 
--- llvm-toolchain-15-15.0.7.orig/mlir/test/Dialect/SPIRV/Transforms/abi-interface.mlir
+++ llvm-toolchain-15-15.0.7/mlir/test/Dialect/SPIRV/Transforms/abi-interface.mlir
@@ -29,3 +29,10 @@ spv.module Logical GLSL450 {
 } // end spv.module
 
 } // end module
+
+// -----
+
+module {
+// expected-error@+1 {{'spirv.module' op missing SPIR-V target env attribute}}
+spirv.module Logical GLSL450 {}
+} // end module
